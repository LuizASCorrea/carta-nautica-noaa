<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Carta Náutica — Todas as Boias (NOAA)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <style>
    :root{ --bg:#070b12; --panel:#0e1626; --accent:#18ffd6; --text:#d6e1ff; --muted:#8aa0c2; --grid:#18ffd61f }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Ubuntu,Arial}
    .app{display:grid;grid-template-columns:340px 1fr;height:100%}
    .sidebar{background:linear-gradient(180deg,rgba(12,18,30,.95),rgba(7,11,18,.98));border-right:1px solid #1b2743;padding:16px;display:flex;flex-direction:column;gap:14px}
    .panel{background:rgba(16,24,38,.7);border:1px solid #1f2b46;border-radius:14px}
    .panel h3{margin:0;padding:12px 14px;font-size:13px;letter-spacing:.1em;text-transform:uppercase;color:#9cc8ff;border-bottom:1px solid #1f2b46}
    .panel .content{padding:12px 14px;font-size:14px}
    .btn{display:inline-block;padding:8px 12px;border:1px solid #1f2b46;border-radius:10px;background:#0e1523;color:#d6e1ff;cursor:pointer}
    #map{height:100%;width:100%}
    #grid{position:absolute;inset:0;pointer-events:none}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 6px;border-bottom:1px dashed #243251}
    th{color:#9cc8ff;text-transform:uppercase;letter-spacing:.06em;text-align:left}
    .hint{color:var(--muted);font-size:12px}
    .credits{position:absolute;right:12px;bottom:12px;background:rgba(10,15,23,.6);border:1px solid #1f2b46;padding:6px 10px;border-radius:10px;font-size:12px;z-index:700}
    .pulse{position:relative}
    .pulse::after{content:"";position:absolute;inset:-6px;border-radius:50%;border:2px solid currentColor;opacity:.6;animation:pulse 1.6s ease-out infinite}
    @keyframes pulse{0%{transform:scale(.4);opacity:.8}100%{transform:scale(1.6);opacity:0}}
    .badge-hs-low  { background:#133a2b; color:#7cf1c3; padding:2px 6px; border-radius:8px }
    .badge-hs-mid  { background:#3a3213; color:#f1d27c; padding:2px 6px; border-radius:8px }
    .badge-hs-high { background:#3a1313; color:#ff9a9a; padding:2px 6px; border-radius:8px }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <section class="panel">
        <h3>Camadas e Controles</h3>
        <div class="content">
          <label style="display:block;margin-bottom:6px">Mapa-base:</label>
          <select id="baseStyle" style="width:100%;background:#0e1523;border:1px solid #1f2b46;padding:8px 10px;border-radius:10px;color:#d6e1ff;outline:none">
            <option value="cartoDark">Carto — Dark Matter (escuro)</option>
            <option value="osm">OSM — Standard</option>
            <option value="cartoLight">Carto — Positron (claro)</option>
            <option value="esriSat">Esri — World Imagery (satélite)</option>
            <option value="opentopo">OpenTopoMap</option>
          </select>
          <div style="height:10px"></div>
          <label><input id="toggleSeamark" type="checkbox" checked> OpenSeaMap (sobreposição)</label><br/>
          <label><input id="toggleGrid" type="checkbox" checked> Grade A–J / 1–10</label><br/>
          <button id="btnRefresh" class="btn" style="margin-top:8px">Recarregar estações</button>
          <hr style="border:none;border-top:1px solid #1f2b46;margin:12px 0">
          <div style="display:grid;gap:8px">
            <input id="searchBox" placeholder="Buscar ID ou nome (ex.: 46237 ou Monterey)" 
                   style="background:#0e1523;border:1px solid #1f2b46;padding:8px 10px;border-radius:10px;color:#d6e1ff;outline:none"/>
            <button id="btnSearch" class="btn">Ir para estação</button>
          </div>
          <label style="display:flex;align-items:center;gap:8px;margin-top:10px">
            <input id="autoRefresh" type="checkbox"> Atualizar estação selecionada a cada 
            <input id="autoRefreshSec" type="number" min="10" value="60" style="width:64px;background:#0e1523;border:1px solid #1f2b46;border-radius:8px;color:#d6e1ff;padding:4px 6px"> s
          </label>
        </div>
      </section>
      <section class="panel">
        <h3>Detalhes da estação</h3>
        <div class="content">
          <div id="stationInfo" class="hint">Clique numa boia no mapa para ver leituras (Hs, Tp, Dir).</div>
          <table id="buoyTable" style="margin-top:8px;display:none">
            <thead><tr><th>ID</th><th>Hs</th><th>Tp</th><th>Dir</th><th>Atualizado</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
      <div class="hint" style="margin-top:auto">Fonte: NDBC/NOAA — WVHT (Hs), DPD (Tp), MWD (Dir)</div>
    </aside>
    <main class="map-wrap" style="position:relative">
      <div id="map"></div>
      <canvas id="grid"></canvas>
      <div class="credits">Camadas: © OpenStreetMap, OpenSeaMap</div>
    </main>
  </div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script>
    const NOAA_BASE = 'http://localhost:5001';
    // mapa e camadas base
    const map = L.map('map').setView([20, -40], 3);
    const baseLayers = {
      // Dark (recomendado)
      cartoDark: L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        { attribution: '&copy; OpenStreetMap &copy; CARTO' }
      ),
      // Padrão OSM
      osm: L.tileLayer(
        'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
        { attribution: '&copy; OpenStreetMap' }
      ),
      // Claro cinza
      cartoLight: L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        { attribution: '&copy; OpenStreetMap &copy; CARTO' }
      ),
      // Satélite
      esriSat: L.tileLayer(
        'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        { attribution: 'Tiles &copy; Esri' }
      ),
      // Topográfico
      opentopo: L.tileLayer(
        'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
        { attribution: 'Map data: &copy; OpenStreetMap, SRTM | Map style: &copy; OpenTopoMap' }
      )
    };
    // sobreposição náutica (mantém)
    const seamark = L.tileLayer(
      'https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png',
      { opacity: .9, attribution: 'OpenSeaMap' }
    );
    // inicia com o DARK
    baseLayers.cartoDark.addTo(map);
    seamark.addTo(map);
    // seletor de estilo
    const baseSelect = document.getElementById('baseStyle');
    function applyBase(){
      // remove todas as bases atuais
      Object.values(baseLayers).forEach(l => { try { map.removeLayer(l); } catch(e){} });
      // adiciona a escolhida
      const key = baseSelect.value;
      baseLayers[key].addTo(map);
      // mantém a sobreposição se marcada
      if(document.getElementById('toggleSeamark').checked) seamark.addTo(map);
    }
    baseSelect.addEventListener('change', applyBase);
    // toggles
    document.getElementById('toggleSeamark').addEventListener('change', e=>{
      if(e.target.checked) seamark.addTo(map); else map.removeLayer(seamark);
    });
    let ALL_STATIONS = [];           // cache das estações /stations
    let selectedStation = null;      // {id, name, lat, lng}
    let autoTimer = null;            // handle do setInterval
    // grade sobreposta
    const gridCanvas=document.getElementById('grid'); const gctx=gridCanvas.getContext('2d');
    function sizeGrid(){const s=map.getSize();gridCanvas.width=s.x;gridCanvas.height=s.y;drawGrid();}
    function drawGrid(){const s=map.getSize();const w=s.x,h=s.y,n=10;gctx.clearRect(0,0,w,h);if(!document.getElementById('toggleGrid').checked)return;gctx.strokeStyle='rgba(24,255,214,0.2)';for(let i=1;i<n;i++){const x=(w/n)*i+.5,y=(h/n)*i+.5;gctx.beginPath();gctx.moveTo(x,0);gctx.lineTo(x,h);gctx.stroke();gctx.beginPath();gctx.moveTo(0,y);gctx.lineTo(w,y);gctx.stroke();}gctx.strokeStyle='#2b3b64';gctx.strokeRect(.5,.5,w-1,h-1);}
    map.on('move zoom resize', sizeGrid); new ResizeObserver(sizeGrid).observe(document.querySelector('.map-wrap')); sizeGrid();
    document.getElementById('toggleGrid').addEventListener('change',drawGrid);
    // cluster de marcadores
    const cluster = L.markerClusterGroup({ disableClusteringAtZoom: 8 });
    map.addLayer(cluster);
    const dotIcon = L.divIcon({html:`<div class="pulse" style="color:#18ffd6"><svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="4"/></svg></div>`,className:'',iconSize:[12,12],iconAnchor:[6,6]});
    // carregar todas as estações
    async function loadStations(){
      cluster.clearLayers();
      setInfo('Carregando estações...');
      try{
        const res = await fetch(`${NOAA_BASE}/stations`);
        ALL_STATIONS = await res.json(); // cache
        const markers = [];
        for(const s of ALL_STATIONS){
          if(s.lat==null || s.lng==null) continue;
          const m = L.marker([s.lat, s.lng], {icon: dotIcon, title: `${s.id} — ${s.name}`});
          m.on('click', ()=> showStation(s));
          markers.push(m);
        }
        cluster.addLayers(markers);
        setInfo(`Estações carregadas: ${markers.length}. Clique em uma para ver leituras.`);
      }catch(e){
        console.error(e);
        setInfo('Falha ao carregar estações.');
      }
    }
    function setInfo(html){ document.getElementById('stationInfo').innerHTML = html; }
    // ao clicar numa estação: busca leituras reais
    function hsBadge(hs){
      if(hs == null) return '-';
      const v = Number(hs);
      if (isNaN(v)) return '-';
      if (v < 1.0)  return `<span class="badge-hs-low">${v.toFixed(1)} m</span>`;
      if (v < 2.5)  return `<span class="badge-hs-mid">${v.toFixed(1)} m</span>`;
      return `<span class="badge-hs-high">${v.toFixed(1)} m</span>`;
    }
    async function showStation(st){
      selectedStation = st;
      setInfo(`<b>${st.id}</b> — ${st.name || ''}<br>Consultando leituras...`);
      try{
        const res = await fetch(`${NOAA_BASE}/noaa?ids=${st.id}`);
        const [row] = await res.json();
        const tbody = document.querySelector('#buoyTable tbody');
        tbody.innerHTML = '';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.id}</td>
          <td>${hsBadge(row.Hs)}</td>
          <td>${row.Tp ?? '-' } s</td>
          <td>${row.Dir ?? '-' }°</td>
          <td><small>${row.time ?? '-'}</small></td>`;
        tbody.appendChild(tr);
        document.getElementById('buoyTable').style.display='table';
        setInfo(`<b>${st.id}</b> — ${st.name || ''}<br><small>${st.lat?.toFixed(3)}, ${st.lng?.toFixed(3)}</small>`);
        map.setView([st.lat, st.lng], Math.max(map.getZoom(), 7));
      }catch(e){
        console.error(e);
        setInfo('Falha ao obter leituras.');
      }
    }
    // Busca por ID ou parte do nome
    document.getElementById('btnSearch').addEventListener('click', ()=>{
      const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();
      if(!q) return;
      const found = ALL_STATIONS.find(s => s.id.toLowerCase() === q || (s.name||'').toLowerCase().includes(q));
      if(!found){
        setInfo('Estação não encontrada.');
        return;
      }
      showStation(found);
    });
    // Auto refresh da estação selecionada
    function stopAuto(){
      if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
    }
    function startAuto(){
      stopAuto();
      const enabled = document.getElementById('autoRefresh').checked;
      const sec = Math.max(10, parseInt(document.getElementById('autoRefreshSec').value||60,10));
      if(enabled && selectedStation){
        autoTimer = setInterval(()=> showStation(selectedStation), sec*1000);
      }
    }
    document.getElementById('autoRefresh').addEventListener('change', startAuto);
    document.getElementById('autoRefreshSec').addEventListener('change', startAuto);
    // Recarregar estações
    document.getElementById('btnRefresh').addEventListener('click', ()=>{
      stopAuto();
      loadStations();
    });
    loadStations(); // inicial
  </script>
</body>
</html>
